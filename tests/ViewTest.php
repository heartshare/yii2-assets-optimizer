<?php

namespace slinstj\AssetsOptimizer\tests;

use yii\web\AssetManager;
use slinstj\AssetsOptimizer\View;
use yii\helpers\FileHelper;
use Yii;

/**
 * Generated by PHPUnit_SkeletonGenerator on 2015-10-30 at 17:45:03.
 */
class ViewTest extends TestCase
{

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp()
    {
        parent::setUp();
        $this->mockWebApplication();
        \Yii::setAlias('@webroot', __DIR__ . '/runtime/web');
        \Yii::setAlias('@web', '/runtime/web');
    }

    protected function tearDown()
    {
        parent::tearDown();
        FileHelper::removeDirectory(Yii::getAlias('@runtime/web'));
    }

    public function testHtmlContainsRightReferencesForAssets()
    {
        $view = $this->mockView();
        $content = $view->renderFile('@yaotests/views/index.php', ['data' => 'Hello World!']);

        $this->assertEquals(1, preg_match('#<link href="/runtime/web/yao/[0-9a-z]+\\.yao\\.css" rel="stylesheet">#', $content), 'Html view does not contain the optimized css file: ' . $content);
        $this->assertEquals(1, preg_match('#<script src="/runtime/web/yao/[0-9a-z]+\\.yao\\.js">#', $content), 'Html view does not contain the optimized JS file: ' . $content);
    }

    public function testOptimizedCssFileExistsOnDefaults()
    {
        $view = $this->mockView();
        $content = $view->renderFile('@yaotests/views/index.php', ['data' => 'Hello World!']);
        $cssUrl = $this->findByRegex('#<link href="(.*)?" rel="stylesheet">#', $content, 1);
        $jsUrl = $this->findByRegex('#<script src="(.*)?">#', $content, 1);
        $cssPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $cssUrl);
        $jsPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $jsUrl);

        $this->assertFileExists($cssPath, "Expected file '$cssUrl' could not be found in '$cssPath'.");
        $this->assertFileExists($jsPath, "Expected file '$jsUrl' could not be found in '$jsPath'.");
    }

    public function testOptimizedCssFileExists()
    {
        $view = $this->mockView([
            'optimizedCssPath' => '@webroot/my/path',
            'optimizedCssUrl' => '@web/my/path',
        ]);
        $content = $view->renderFile('@yaotests/views/index.php', ['data' => 'Hello World!']);
        $cssUrl = $this->findByRegex('#<link href="(.*)?" rel="stylesheet">#', $content, 1);
        $jsUrl = $this->findByRegex('#<script src="(.*)?">#', $content, 1);
        $cssPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $cssUrl);
        $jsPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $jsUrl);

        $this->assertFileExists($cssPath, "Expected file '$cssUrl' could not be found in '$cssPath'.");
        $this->assertFileExists($jsPath, "Expected file '$jsUrl' could not be found in '$jsPath'.");
    }

    public function testOptimizedCssFileNotExists()
    {
        $view = $this->mockView([
            'optimizedCssPath' => '@webroot/other/path',
        ]);
        $content = $view->renderFile('@yaotests/views/index.php', ['data' => 'Hello World!']);
        $cssUrl = $this->findByRegex('#<link href="(.*)?" rel="stylesheet">#', $content, 1);
        $jsUrl = $this->findByRegex('#<script src="(.*)?">#', $content, 1);
        $cssPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $cssUrl);
        $jsPath = \Yii::getAlias('@webroot') . str_replace(\Yii::getAlias('@web'), '', $jsUrl);

        $this->assertFileNotExists($cssPath, "Expected file '$cssUrl' SHOULD NOT be found in '$cssPath'.");
        $this->assertFileNotExists($jsPath, "Expected file '$jsUrl' SHOULD NOT be found in '$jsPath'.");
    }

    /**
     * @return View
     */
    protected function mockView(array $config = [])
    {
        return new View(\yii\helpers\ArrayHelper::merge([
            'assetManager' => $this->mockAssetManager(),
        ], $config));
    }

    protected function mockAssetManager()
    {
        $assetDir = Yii::getAlias('@runtime/web/assets');
        if (!is_dir($assetDir)) {
            mkdir($assetDir, 0777, true);
        }

        return new AssetManager([
            'basePath' => $assetDir,
            'baseUrl' => '/assets',
        ]);
    }

    protected function findByRegex($regex, $content, $match = 1)
    {
        $matches = [];
        preg_match($regex, $content, $matches);
        return !isset($matches[$match]) ?: $matches[$match];
    }
}
